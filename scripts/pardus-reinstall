#!/bin/bash
mkdir -p /source /target
mount /dev/loop0 /source
mount "$1" /target
mkdir -p /target/pardus.old
old="/target/pardus.old"
new="/target"
mv $new/* $old/ || true
cp -prf /source/* /target/
sync
cp $old/etc/fstab $new/etc/fstab
for user in $(grep $new/etc/passwd -e "x:[0-9][0-9][0-9][0-9]:[0-9][0-9][0-9][0-9]" | cut -f 1 -d ':') ; do
    grep $old/etc/passwd -e "^$user:" >> $new/etc/passwd
    grep $old/etc/shadow -e "^$user:" >> $new/etc/shadow
    for group in audio video netdev plugdev bluetooth cdrom floppy sudo ; do
        chroot $new usermod -a -G "$group" "$user" || true
    done
done
mv $old/home/* $new/home/ || true
cat $old/etc/default/keyboard > $new/etc/default/keyboard
cat $old/etc/timezone > $new/etc/timezone
cat $old/etc/default/locale > $new/etc/default/locale
chroot $new apt purge live-* -yq
bash /usr/lib/live-installer/scripts/fetch-pkg-debian.sh || true
for i in dev sys proc run ; do
    mount --bind /$i /target/$i
done